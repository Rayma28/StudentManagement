{% extends 'base.html' %}
{% load widget_tweaks %}

{% block title %}Upload Result - Student Management System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-upload me-2"></i>Upload Student Result</h2>
        <p class="text-muted">Add academic results for students</p>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-plus-circle me-2"></i>Add New Result</h5>
            </div>
            <div class="card-body">
                {% if messages %}
                    <ul class="messages">
                        {% for message in messages %}
                            <li class="alert alert-{{ message.tags }}">{{ message }}</li>
                        {% endfor %}
                    </ul>
                {% endif %}
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.student.id_for_label }}" class="form-label">
                                    <i class="fas fa-user me-1"></i>Student
                                </label>
                                {{ form.student|add_class:"form-select" }}
                                {% if form.student.errors %}
                                    <div class="text-danger">{{ form.student.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.semester.id_for_label }}" class="form-label">
                                    <i class="fas fa-calendar-alt me-1"></i>Semester
                                </label>
                                {{ form.semester|add_class:"form-select" }}
                                {% if form.semester.errors %}
                                    <div class="text-danger">{{ form.semester.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label for="{{ form.subject.id_for_label }}" class="form-label">
                                    <i class="fas fa-book me-1"></i>Subject
                                </label>
                                {{ form.subject|add_class:"form-select"|attr:"disabled:disabled" }}
                                {% if form.subject.errors %}
                                    <div class="text-danger">{{ form.subject.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="{{ form.marks.id_for_label }}" class="form-label">
                                    <i class="fas fa-trophy me-1"></i>Marks Obtained
                                </label>
                                {{ form.marks|add_class:"form-control" }}
                                {% if form.marks.errors %}
                                    <div class="text-danger">{{ form.marks.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="{{ form.total_marks.id_for_label }}" class="form-label">
                                    <i class="fas fa-calculator me-1"></i>Total Marks
                                </label>
                                {{ form.total_marks|add_class:"form-control" }}
                                {% if form.total_marks.errors %}
                                    <div class="text-danger">{{ form.total_marks.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="{{ form.grade.id_for_label }}" class="form-label">
                                    <i class="fas fa-medal me-1"></i>Grade
                                </label>
                                {{ form.grade|add_class:"form-control" }}
                                {% if form.grade.errors %}
                                    <div class="text-danger">{{ form.grade.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.exam_date.id_for_label }}" class="form-label">
                                    <i class="fas fa-calendar me-1"></i>Exam Date
                                </label>
                                {{ form.exam_date|add_class:"form-control" }}
                                {% if form.exam_date.errors %}
                                    <div class="text-danger">{{ form.exam_date.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.result_file.id_for_label }}" class="form-label">
                                    <i class="fas fa-file me-1"></i>Result File (Optional)
                                </label>
                                {{ form.result_file|add_class:"form-control" }}
                                {% if form.result_file.errors %}
                                    <div class="text-danger">{{ form.result_file.errors }}</div>
                                {% endif %}
                                <div class="form-text">Upload PDF or image file of the result (optional)</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-upload me-2"></i>Upload Result
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-info-circle me-2"></i>Instructions</h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled">
                    <li><i class="fas fa-check text-success me-2"></i>Select the student from dropdown (if applicable)</li>
                    <li><i class="fas fa-check text-success me-2"></i>Choose the appropriate semester</li>
                    <li><i class="fas fa-check text-success me-2"></i>Select subject based on semester</li>
                    <li><i class="fas fa-check text-success me-2"></i>Input marks and total marks</li>
                    <li><i class="fas fa-check text-success me-2"></i>Grade will be auto-calculated</li>
                    <li><i class="fas fa-check text-success me-2"></i>Specify exam date</li>
                    <li><i class="fas fa-check text-success me-2"></i>Optionally upload result file</li>
                </ul>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h6><i class="fas fa-chart-bar me-2"></i>Grading Scale</h6>
            </div>
            <div class="card-body">
                <small>
                    <div class="mb-1"><span class="badge bg-success">A+</span> 90-100%</div>
                    <div class="mb-1"><span class="badge bg-success">A</span> 80-89%</div>
                    <div class="mb-1"><span class="badge bg-primary">B+</span> 70-79%</div>
                    <div class="mb-1"><span class="badge bg-primary">B</span> 60-69%</div>
                    <div class="mb-1"><span class="badge bg-warning">C+</span> 50-59%</div>
                    <div class="mb-1"><span class="badge bg-warning">C</span> 40-49%</div>
                    <div><span class="badge bg-danger">F</span> Below 40%</div>
                </small>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const semesterSelect = document.getElementById('id_semester');
    const subjectSelect = document.getElementById('id_subject');

    if (semesterSelect && subjectSelect) {
        console.log('Semester select found:', semesterSelect);
        console.log('Subject select found:', subjectSelect);

        // Disable subject dropdown by default
        subjectSelect.disabled = true;
        subjectSelect.innerHTML = '<option value="">Select a semester first</option>';

        semesterSelect.addEventListener('change', function() {
            const semesterId = this.value;
            console.log('Semester changed to:', semesterId);

            if (semesterId) {
                subjectSelect.disabled = true;
                subjectSelect.innerHTML = '<option value="">Loading subjects...</option>';

                fetch(`/students/get-subjects/?semester_id=${semesterId}`, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                    .then(response => {
                        console.log('Fetch response status:', response.status);
                        if (!response.ok) {
                            throw new Error('Network response was not ok: ' + response.statusText);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Received data:', data);
                        subjectSelect.innerHTML = '<option value="">Select Subject</option>';
                        if (data.subjects && data.subjects.length > 0) {
                            data.subjects.forEach(subject => {
                                const option = document.createElement('option');
                                option.value = subject.id;
                                option.textContent = subject.name;
                                subjectSelect.appendChild(option);
                            });
                            console.log('Subjects populated, enabling dropdown');
                            subjectSelect.disabled = false;
                        } else {
                            console.log('No subjects found for semester');
                            subjectSelect.innerHTML = '<option value="">No subjects available</option>';
                            subjectSelect.disabled = true;
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching subjects:', error);
                        subjectSelect.innerHTML = '<option value="">Error loading subjects</option>';
                        subjectSelect.disabled = true;
                        alert('Failed to load subjects: ' + error.message);
                    });
            } else {
                console.log('No semester selected, disabling subject dropdown');
                subjectSelect.disabled = true;
                subjectSelect.innerHTML = '<option value="">Select a semester first</option>';
            }
        });

        // Trigger change event on page load if semester is pre-selected
        if (semesterSelect.value) {
            console.log('Pre-selected semester detected:', semesterSelect.value);
            semesterSelect.dispatchEvent(new Event('change'));
        } else {
            console.log('No pre-selected semester');
        }
    } else {
        console.error('Semester or subject select not found');
    }
});
</script>
{% endblock %}
